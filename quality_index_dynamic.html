<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quality Reports - Mahabharata Pipeline</title>
    <link rel="stylesheet" href="static/styles.css">
    <style>
        .quality-header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }
        
        .quality-header h1 { font-size: 2rem; margin-bottom: 10px; }
        .quality-header p { opacity: 0.9; }
        
        .content { max-width: 1200px; margin: 0 auto; padding: 30px; }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .summary-card .number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .summary-card .label {
            color: #636e72;
            font-size: 0.9rem;
        }
        
        .summary-card.danger .number { color: #dc3545; }
        .summary-card.warning .number { color: #ffc107; }
        .summary-card.info .number { color: #17a2b8; }
        .summary-card.success .number { color: #28a745; }
        
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .book-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            cursor: pointer;
        }
        
        .book-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }
        
        .book-card-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .book-card-header.has-issues {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }
        
        .book-card-header.clean {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        
        .book-card-header.pending {
            background: linear-gradient(135deg, #636e72 0%, #2d3436 100%);
        }
        
        .book-card-header h3 { margin: 0; font-size: 1.2rem; }
        .book-card-header p { margin: 5px 0 0; opacity: 0.9; font-size: 0.9rem; }
        
        .book-card-body {
            padding: 20px;
        }
        
        .issue-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .issue-row:last-child { border-bottom: none; }
        
        .issue-label { color: #636e72; }
        .issue-value { font-weight: bold; }
        .issue-value.danger { color: #dc3545; }
        .issue-value.warning { color: #ffc107; }
        .issue-value.success { color: #28a745; }
        
        .section-title {
            font-size: 1.5rem;
            margin-bottom: 25px;
            color: #2d3436;
            border-bottom: 3px solid #667eea;
            padding-bottom: 10px;
            display: inline-block;
        }
        
        /* Duplicates section */
        .duplicates-section {
            margin-top: 40px;
            padding: 20px;
            background: #fff3cd;
            border-radius: 12px;
            border-left: 4px solid #ffc107;
        }
        
        .duplicates-section h3 {
            margin-top: 0;
            color: #856404;
        }
        
        .duplicate-list {
            max-height: 400px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            padding: 15px;
        }
        
        .duplicate-item {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
        }
        
        .duplicate-item:last-child { border-bottom: none; }
        
        .duplicate-id {
            font-family: monospace;
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .duplicate-count {
            color: #dc3545;
            font-weight: bold;
        }
        
        .texts-differ {
            color: #dc3545;
            font-size: 0.8rem;
        }
        
        .texts-same {
            color: #28a745;
            font-size: 0.8rem;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
        }
        
        .modal.active { display: flex; align-items: center; justify-content: center; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
        }
        
        .modal-close {
            font-size: 2rem;
            cursor: pointer;
            color: #636e72;
        }
        
        .modal-close:hover { color: #2d3436; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <a href="index.html">üïâÔ∏è Mahabharata Pipeline Dashboard</a>
        </div>
        <div class="nav-links">
            <a href="index.html">Home</a>
            <a href="corpus_structure.html">üìä Structure</a>
            <a href="quality_index_dynamic.html" class="active">üîç Quality</a>
        </div>
    </nav>

    <!-- Header -->
    <header class="quality-header">
        <h1>üîç Data Quality Reports</h1>
        <p>Analysis of duplicate IDs, missing sequences, and data integrity issues</p>
    </header>

    <!-- Content -->
    <div class="content">
        <!-- Summary Stats -->
        <div class="summary-grid" id="summary-grid">
            <div class="summary-card info">
                <div class="number" id="total-shlokas">--</div>
                <div class="label">Total Shlokas</div>
            </div>
            <div class="summary-card info">
                <div class="number" id="books-processed">--</div>
                <div class="label">Books Processed</div>
            </div>
            <div class="summary-card danger">
                <div class="number" id="total-duplicates">--</div>
                <div class="label">Duplicate IDs</div>
            </div>
            <div class="summary-card danger">
                <div class="number" id="total-missing">--</div>
                <div class="label">Missing Verses</div>
            </div>
            <div class="summary-card warning">
                <div class="number" id="low-confidence">--</div>
                <div class="label">Low Confidence</div>
            </div>
            <div class="summary-card success">
                <div class="number" id="high-confidence">--</div>
                <div class="label">High Confidence</div>
            </div>
        </div>

        <!-- Books Grid -->
        <h2 class="section-title">üìö Quality by Book</h2>
        <div class="books-grid" id="books-grid">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <!-- Modal for duplicate details -->
    <div class="modal" id="duplicates-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Duplicate IDs - Book XX</h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modal-body">
                <!-- Populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>Mahabharata Pipeline | Data Quality Analysis</p>
        </div>
    </footer>

    <script src="static/paths.js"></script>
    <script>
        // Book names
        const BOOK_NAMES = {
            1: 'Adi Parva', 2: 'Sabha Parva', 3: 'Vana Parva', 4: 'Virata Parva',
            5: 'Udyoga Parva', 6: 'Bhishma Parva', 7: 'Drona Parva', 8: 'Karna Parva',
            9: 'Shalya Parva', 10: 'Sauptika Parva', 11: 'Stri Parva', 12: 'Shanti Parva',
            13: 'Anushasana Parva', 14: 'Ashvamedhika Parva', 15: 'Ashramavasika Parva',
            16: 'Mausala Parva', 17: 'Mahaprasthanika Parva', 18: 'Svargarohana Parva',
            19: 'Harivamsa (Khila)'
        };
        
        let allBooksData = [];
        let qualityData = {};
        
        async function loadData() {
            try {
                // Load main summary
                const summaryResp = await fetch('data/all_books_summary.json');
                allBooksData = await summaryResp.json();
                
                // Try to load quality data for each processed book
                for (const book of allBooksData) {
                    const bookNum = book.book_number;
                    try {
                        // Try new quality.json first, fall back to duplicates.json
                        let resp = await fetch(`data/book_${String(bookNum).padStart(2, '0')}_quality.json`);
                        if (!resp.ok) {
                            resp = await fetch(`data/book_${String(bookNum).padStart(2, '0')}_duplicates.json`);
                        }
                        if (resp.ok) {
                            qualityData[bookNum] = await resp.json();
                        }
                    } catch (e) {
                        // Quality file may not exist
                    }
                }
                
                renderSummary();
                renderBookCards();
            } catch (error) {
                console.error('Failed to load data:', error);
                document.getElementById('books-grid').innerHTML = 
                    '<p style="color: #dc3545;">Failed to load quality data. Run the pipeline first.</p>';
            }
        }
        
        function renderSummary() {
            let totalShlokas = 0;
            let totalDuplicates = 0;
            let totalMissing = 0;
            let highConf = 0;
            let lowConf = 0;
            
            for (const book of allBooksData) {
                totalShlokas += book.total || 0;
                totalDuplicates += book.duplicate_ids || 0;
                totalMissing += book.missing_verses || 0;
                highConf += book.high_confidence || 0;
                lowConf += book.low_confidence || 0;
            }
            
            document.getElementById('total-shlokas').textContent = totalShlokas.toLocaleString();
            document.getElementById('books-processed').textContent = allBooksData.length;
            document.getElementById('total-duplicates').textContent = totalDuplicates.toLocaleString();
            document.getElementById('total-missing').textContent = totalMissing.toLocaleString();
            document.getElementById('high-confidence').textContent = highConf.toLocaleString();
            document.getElementById('low-confidence').textContent = lowConf.toLocaleString();
        }
        
        function renderBookCards() {
            const grid = document.getElementById('books-grid');
            let html = '';
            
            // Create cards for all 19 books
            for (let bookNum = 1; bookNum <= 19; bookNum++) {
                const book = allBooksData.find(b => b.book_number === bookNum);
                const bookName = BOOK_NAMES[bookNum];
                const hasData = !!book;
                const dupCount = book?.duplicate_ids || 0;
                const missingCount = book?.missing_verses || 0;
                const lowConf = book?.low_confidence || 0;
                const hasIssues = dupCount > 0 || missingCount > 0 || lowConf > 10;
                
                let headerClass = 'pending';
                if (hasData) {
                    headerClass = hasIssues ? 'has-issues' : 'clean';
                }
                
                html += `
                    <div class="book-card" onclick="${hasData ? `showQualityDetails(${bookNum})` : ''}">
                        <div class="book-card-header ${headerClass}">
                            <h3>Book ${String(bookNum).padStart(2, '0')}</h3>
                            <p>${bookName}</p>
                        </div>
                        <div class="book-card-body">
                            ${hasData ? `
                                <div class="issue-row">
                                    <span class="issue-label">Total Shlokas:</span>
                                    <span class="issue-value">${(book.total || 0).toLocaleString()}</span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Match Rate:</span>
                                    <span class="issue-value ${book.match_rate >= 95 ? 'success' : book.match_rate >= 80 ? 'warning' : 'danger'}">${book.match_rate}%</span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Duplicate IDs:</span>
                                    <span class="issue-value ${dupCount > 0 ? 'danger' : 'success'}">${dupCount}</span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Missing Verses:</span>
                                    <span class="issue-value ${missingCount > 0 ? 'danger' : 'success'}">${missingCount}</span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Low Confidence:</span>
                                    <span class="issue-value ${lowConf > 10 ? 'warning' : 'success'}">${lowConf}</span>
                                </div>
                                <div class="issue-row">
                                    <span class="issue-label">Status:</span>
                                    <span class="issue-value ${hasIssues ? 'danger' : 'success'}">
                                        ${hasIssues ? '‚ö†Ô∏è Issues' : '‚úÖ Clean'}
                                    </span>
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 20px; color: #636e72;">
                                    <p>Not yet processed</p>
                                    <p style="font-size: 0.8rem;">Run pipeline for this book</p>
                                </div>
                            `}
                        </div>
                    </div>
                `;
            }
            
            grid.innerHTML = html;
        }
        
        function showQualityDetails(bookNum) {
            const modal = document.getElementById('duplicates-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');
            
            title.textContent = `Quality Report - Book ${String(bookNum).padStart(2, '0')} (${BOOK_NAMES[bookNum]})`;
            
            const data = qualityData[bookNum];
            let html = '';
            
            // Duplicates section
            if (!data || !data.duplicates || data.duplicates.length === 0) {
                html += '<div class="duplicates-section" style="background: #d4edda; border-left-color: #28a745;"><h3 style="color: #155724;">‚úÖ No duplicate IDs</h3></div>';
            } else {
                html += `
                    <div class="duplicates-section">
                        <h3>‚ö†Ô∏è Duplicate IDs: ${data.total_duplicate_ids} (${data.total_duplicate_entries} entries)</h3>
                        <p>These IDs appear more than once in the source data, which may cause incorrect matches.</p>
                    </div>
                    <div class="duplicate-list" style="max-height: 200px;">
                `;
                
                for (const dup of data.duplicates.slice(0, 20)) {  // Show first 20
                    html += `
                        <div class="duplicate-item">
                            <div>
                                <span class="duplicate-id">${dup.id}</span>
                                <span class="duplicate-count">√ó${dup.count}</span>
                                ${dup.texts_are_identical 
                                    ? '<span class="texts-same">(identical)</span>' 
                                    : '<span class="texts-differ">(DIFFER!)</span>'}
                            </div>
                        </div>
                    `;
                }
                if (data.duplicates.length > 20) {
                    html += `<div style="padding: 10px; color: #636e72;">... and ${data.duplicates.length - 20} more</div>`;
                }
                html += '</div>';
            }
            
            // Gaps section
            html += '<div style="margin-top: 20px;"></div>';
            
            if (!data || !data.gaps || data.gaps.length === 0) {
                html += '<div class="duplicates-section" style="background: #d4edda; border-left-color: #28a745;"><h3 style="color: #155724;">‚úÖ No missing verses (sequence gaps)</h3></div>';
            } else {
                html += `
                    <div class="duplicates-section">
                        <h3>‚ö†Ô∏è Missing Verses: ${data.total_missing_verses} in ${data.total_chapters_with_gaps} chapters</h3>
                        <p>Gaps in verse numbering sequences - some verse numbers are missing.</p>
                    </div>
                    <div class="duplicate-list" style="max-height: 200px;">
                `;
                
                for (const gap of data.gaps.slice(0, 20)) {  // Show first 20
                    html += `
                        <div class="duplicate-item">
                            <div>
                                <strong>Chapter ${gap.chapter}</strong>
                                ${gap.adhyaya_name ? `(${gap.adhyaya_name})` : ''}
                                <span class="duplicate-count" style="margin-left: 10px;">${gap.missing_count} missing</span>
                            </div>
                            <div style="margin-top: 5px; font-size: 0.85rem; color: #636e72;">
                                Range: ${gap.range} | Missing: ${gap.missing_numbers.slice(0, 10).join(', ')}${gap.missing_numbers.length > 10 ? '...' : ''}
                            </div>
                        </div>
                    `;
                }
                if (data.gaps.length > 20) {
                    html += `<div style="padding: 10px; color: #636e72;">... and ${data.gaps.length - 20} more chapters</div>`;
                }
                html += '</div>';
            }
            
            body.innerHTML = html;
            modal.classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('duplicates-modal').classList.remove('active');
        }
        
        // Close modal on outside click
        document.getElementById('duplicates-modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
